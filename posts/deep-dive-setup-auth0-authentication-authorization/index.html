<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Protect FastAPI API endpoints with Auth0 | Learn part by part</title>
<meta name=keywords content="howto,oauth,auth0,api"><meta name=description content="Learn how to protect your FastAPI API endpoints using Auth0"><meta name=author content><link rel=canonical href=https://partbypart.github.io/posts/deep-dive-setup-auth0-authentication-authorization/><meta name=google-site-verification content="G-MF6MC03DXC"><link crossorigin=anonymous href=/assets/css/stylesheet.c7cdf9ec6ae3b64eadba619dd56fa18edf29c5eccfcb44ab0084078b63dfa9c7.css integrity="sha256-x8357Grjtk6tumGd1W+hjt8pxezPy0SrAIQHi2Pfqcc=" rel="preload stylesheet" as=style><link rel=icon href=https://partbypart.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://partbypart.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://partbypart.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://partbypart.github.io/apple-touch-icon.png><link rel=mask-icon href=https://partbypart.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=alternate hreflang=en href=https://partbypart.github.io/posts/deep-dive-setup-auth0-authentication-authorization/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-MF6MC03DXC"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-MF6MC03DXC")}</script><meta property="og:url" content="https://partbypart.github.io/posts/deep-dive-setup-auth0-authentication-authorization/"><meta property="og:site_name" content="Learn part by part"><meta property="og:title" content="Protect FastAPI API endpoints with Auth0"><meta property="og:description" content="Learn how to protect your FastAPI API endpoints using Auth0"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-02T00:00:00+00:00"><meta property="article:modified_time" content="2025-04-02T00:00:00+00:00"><meta property="article:tag" content="Howto"><meta property="article:tag" content="Oauth"><meta property="article:tag" content="Auth0"><meta property="article:tag" content="Api"><meta property="og:image" content="https://partbypart.github.io/posts/deep-dive-setup-auth0-authentication-authorization/images/oauth-auth0-api.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://partbypart.github.io/posts/deep-dive-setup-auth0-authentication-authorization/images/oauth-auth0-api.png"><meta name=twitter:title content="Protect FastAPI API endpoints with Auth0"><meta name=twitter:description content="Learn how to protect your FastAPI API endpoints using Auth0"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://partbypart.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Protect FastAPI API endpoints with Auth0","item":"https://partbypart.github.io/posts/deep-dive-setup-auth0-authentication-authorization/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Protect FastAPI API endpoints with Auth0","name":"Protect FastAPI API endpoints with Auth0","description":"Learn how to protect your FastAPI API endpoints using Auth0","keywords":["howto","oauth","auth0","api"],"articleBody":"Prerequisites Create an account on https://auth0.com/signup with a free plan\nNavigate to “Applications -\u003e Applications” to see your “Default App”. Grab the “Client ID”, “Client Secret” and “Domain” from “Settings” page of Default App\nNavigate to “Applications -\u003e Applications -\u003e Default App -\u003e API”\nCheck Auth0 Management API checkbox to access management API using this app credentials Click on the drop down to select the scopes/permissions for this app and select read:users, update:users, read:roles scopes. These will be required later to assign roles users after they complete a sign up Create a new API application on Auth0 : “Applications -\u003e API -\u003e Create API”\nName: (Example: “sample-api”) Identifier: (This will be the audience in the issued token) (Example: “https://api.example.com”) JWT Signing algorithm: RS256 Create permissions for your API: Applications -\u003e API -\u003e -\u003e Permissions\nUse “Add a permission” to add any number of permissions that you wish to use for all your endpoints. For this example: Permission: “read:messages” Description: “Read messages from a private endpoint with scope” These permissions can either be granted to the web app (Tokens created using client credentials) OR to web app users using “Roles” and RBAC controls in Auth0 Go to settings of the API created and check “Enable RBAC” box and “Add permissions in the access token” box. This allows access token to apply RBAC rules and inject required scopes into the token\nNavigate to “Applications -\u003e Applications -\u003e Default App -\u003e APIs” and perform the following actions:\nTurn on authorization for “sample-api” Expand the dropdown to select granular permissions read:messages These are general set of scopes to be used by the entire webapp (Default app). An access token created using the webapp’s client credentials will receive an access token with read:messages NOTE: A user using this webapp that has authorization for this API will not receive this permission by default. If a user logs in to the webapp using consent screen, their access token will not have this permission by default. You have to create “Role” and enable RBAC controls to generate user access tokens with these permissions Optional user scope management For a production webapp, you would ideally: Create a Role (User management -\u003e Roles) Make a note of the “Role ID” displayed below the name of the Role Click “Permissions -\u003e Add permissions \" for the created role Select permissions from existing APIs (For example: Selecting “sample-api” will show you “read:messages” as an available permission) and click “Add permissions” Click “Actions -\u003e Triggers -\u003e post-user-registration” (triggers after a new user has been created in the database.) “Add action -\u003e + -\u003e Build from scratch” Name: “Assign roles to users after signup” Trigger: “Post User Registration” Create Add the following secrets on the left side panel for the script to use clientId (Client ID of your Default App) clientSecret (Client secret of your Default App) domain (Domain name of your Auth0 tenant account) user_role_id (The role id you want to assign all signed up users) Add the following script that creates a management client instance and updates the roles of a user exports.onExecutePostUserRegistration = async (event, api) =\u003e { const ManagementClient = require('auth0').ManagementClient; // Initialize the Management Client const management = new ManagementClient({ domain: event.secrets.domain, clientId: event.secrets.clientId, clientSecret: event.secrets.clientSecret, scope: 'read:users update:users read:roles' }); const userId = event.user.user_id; const roleId = event.secrets.user_role_id; try { // Get the user's current roles const userRoles = await management.getUserRoles({ id: userId }); // Check if the user already has the \"User\" role const hasUserRole = userRoles.some(role =\u003e role.id === roleId); if (!hasUserRole) { // Assign the \"User\" role to the user await management.assignRolestoUser({ id: userId }, { roles: [roleId] }); console.log(`Assigned \"User\" role to user ${userId}`); } } catch (e) { console.error('Error assigning role:', e); } }; This will ensure that every user that signs up will have the Role attached to them and hence the permissions that come with the role. This will add the role’s permissions/scopes to the access tokens issued to the user after they login. Verify access to API using audience Now that your Default App has authorization to use your newly created API, lets test it out. Get your Client ID, client secret and domain from the Settings page of your “Default App” Send a curl request to verify if we get back an access token with “sample-api” identifier as audience Export webapp details as environment variables export CLIENT_ID= export CLIENT_SECRET= export DOMAIN= Curl request curl --request POST \\ --url \"https://$DOMAIN/oauth/token\" \\ --header 'content-type: application/json' \\ --data @- \u003c\u003c EOF | jq { \"client_id\":\"$CLIENT_ID\", \"client_secret\":\"$CLIENT_SECRET\", \"audience\":\"https://api.example.com\", \"grant_type\":\"client_credentials\" } EOF Response { \"access_token\": \"eyJhbGciOiJSUzI1NiIsInR5cCI...\", \"scope\": \"read:messages\", \"expires_in\": 86400, \"token_type\": \"Bearer\" } export ACCESS_TOKEN=\"eyJhbGciOiJSUzI1NiIsInR5cCI...\" Display the contents of access token payload to check if the right audience and scopes are injected $ echo $ACCESS_TOKEN | cut -d '.' -f2 | base64 -d |jq { \"iss\": \"\", \"sub\": \"XStySocTNNAJkwa7kTNNGqrwYpHmueq7@clients\", \"aud\": \"https://api.example.com\", \"iat\": 1744935715, \"exp\": 1745022115, \"scope\": \"read:messages\", \"gty\": \"client-credentials\", \"azp\": \"XStySocTNNAJkwa7kTNNGqrwYpHmueq7\", \"permissions\": [ \"read:messages\" ] } Protect your webapp backend API endpoints Create a simple FastAPI backend server Create a .env file and store Auth0 domain and Auth0 API audience value for the backend server to validate incoming bearer tokens Example: $ cat .env AUTH0_DOMAIN=dev-s6oegu3u80a0upg4.us.auth0.com API_AUDIENCE=https://api.example.com Create 3 API endpoints /public - Returns a 200 OK success response without any authentication /private - Returns a 200 OK success response with a valid bearer token (no scope requiredment). Error otherwise /private/scoped - Returns a 200 OK success response with a valid bearer token and a valid scope. Error otherwise Sample server Create a new directory for sample server backend\nmkdir auth0-fastapi-api-protection; cd auth0-fastapi-api-protection Create a virtual environment to install dependencies using uv\npip install uv uvicorn; uv venv .venv Create a requirements.txt to list the dependencies to install\nrequirements.txt fastapi uvicorn[standard] python-jose[cryptography] requests jwt Install dependencies using uv\nsource .venv/bin/activate; uv pip install -r requirements.txt Create a server.py file with the following contents\nfrom fastapi import FastAPI, Depends, HTTPException, status, Security from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials, SecurityScopes from fastapi.responses import JSONResponse from jose import jwt, JWTError, ExpiredSignatureError from typing import Dict, Any import requests import os from dotenv import load_dotenv from pydantic import BaseModel from functools import lru_cache import logging from datetime import datetime, timezone # Configure logging logging.basicConfig(level=logging.INFO) logger = logging.getLogger(__name__) # Load environment variables load_dotenv() # Environment variables AUTH0_DOMAIN = os.getenv(\"AUTH0_DOMAIN\") API_AUDIENCE = os.getenv(\"API_AUDIENCE\") ALGORITHMS = [\"RS256\"] # Ensure required environment variables are set if not all([AUTH0_DOMAIN, API_AUDIENCE]): raise RuntimeError(\"Missing required environment variables\") # Initialize FastAPI app app = FastAPI( title=\"Secure API\", description=\"API with JWT-based authentication and authorization\", version=\"1.0.0\" ) # Security scheme bearer_scheme = HTTPBearer() # Pydantic models for response standardization class ErrorResponse(BaseModel): error: str detail: str class SuccessResponse(BaseModel): status: str data: Dict[str, Any] message: str # Cache JWKS with LRU cache @lru_cache(maxsize=1) def fetch_jwks(): try: jwks_url = f\"https://{AUTH0_DOMAIN}/.well-known/jwks.json\" response = requests.get(jwks_url, timeout=5) response.raise_for_status() return response.json() except requests.RequestException as e: logger.error(f\"Failed to fetch JWKS: {str(e)}\") raise HTTPException( status_code=status.HTTP_503_SERVICE_UNAVAILABLE, detail=\"Unable to fetch authentication keys\" ) def get_signing_key(token: str) -\u003e Dict[str, Any]: try: unverified_header = jwt.get_unverified_header(token) kid = unverified_header.get(\"kid\") jwks = fetch_jwks() key = next((k for k in jwks[\"keys\"] if k[\"kid\"] == kid), None) if key is None: raise HTTPException( status_code=status.HTTP_401_UNAUTHORIZED, detail=\"Invalid signing key\" ) return key except JWTError as e: logger.error(f\"Error processing token header: {str(e)}\") raise HTTPException( status_code=status.HTTP_401_UNAUTHORIZED, detail=\"Invalid token header\" ) async def verify_token( credentials: HTTPAuthorizationCredentials = Depends(bearer_scheme) ) -\u003e Dict[str, Any]: token = credentials.credentials try: rsa_key = get_signing_key(token) payload = jwt.decode( token, rsa_key, algorithms=ALGORITHMS, audience=API_AUDIENCE, issuer=f\"https://{AUTH0_DOMAIN}/\" ) logger.info(f\"Token verified for user: {payload.get('sub')}\") return payload except ExpiredSignatureError: logger.warning(\"Token expired\") raise HTTPException( status_code=status.HTTP_401_UNAUTHORIZED, detail=ErrorResponse( error=\"token_expired\", detail=\"The provided token has expired\" ).model_dump() ) except JWTError as e: logger.warning(f\"Token validation failed: {str(e)}\") raise HTTPException( status_code=status.HTTP_401_UNAUTHORIZED, detail=ErrorResponse( error=\"invalid_token\", detail=f\"Token validation failed: {str(e)}\" ).model_dump() ) async def verify_token_with_scopes( security_scopes: SecurityScopes, payload: Dict[str, Any] = Depends(verify_token) ) -\u003e Dict[str, Any]: token_scopes = payload.get(\"scope\", \"\").split() missing_scopes = [scope for scope in security_scopes.scopes if scope not in token_scopes] if missing_scopes: logger.warning(f\"{datetime.now(timezone.utc).isoformat()}: Missing required scopes: {missing_scopes}\") raise HTTPException( status_code=status.HTTP_403_FORBIDDEN, detail=ErrorResponse( error=\"insufficient_scopes\", detail=f\"Missing required scopes: {', '.join(missing_scopes)}\" ).model_dump() ) return payload @app.exception_handler(HTTPException) async def http_exception_handler(request, exc): # Handle both dictionary and string detail formats if isinstance(exc.detail, dict): error = exc.detail.get(\"error\", \"unknown_error\") detail = exc.detail.get(\"detail\", str(exc.detail)) else: error = \"unknown_error\" detail = str(exc.detail) return JSONResponse( status_code=exc.status_code, content={ \"error\": error, \"detail\": detail } ) @app.get( \"/public\", response_model=SuccessResponse, summary=\"Public endpoint\", description=\"Accessible without authentication\" ) async def public_endpoint(): return SuccessResponse( status=\"success\", data={}, message=\"Successfully accessed public endpoint\" ) @app.get( \"/private\", response_model=SuccessResponse, summary=\"Private endpoint\", description=\"Requires valid JWT authentication\" ) async def private_endpoint(payload: Dict[str, Any] = Depends(verify_token)): return SuccessResponse( status=\"success\", data={\"user\": payload}, message=\"Successfully accessed private endpoint\" ) @app.get( \"/private/scoped\", response_model=SuccessResponse, summary=\"Scoped private endpoint\", description=\"Requires valid JWT with 'read:messages' scope\" ) async def private_scoped_endpoint( payload: Dict[str, Any] = Security(verify_token_with_scopes, scopes=[\"read:messages\"]) ): return SuccessResponse( status=\"success\", data={\"user\": payload}, message=\"Successfully accessed scoped private endpoint\" ) Start the server $ uvicorn server:app --reload --port 8000 INFO: Will watch for changes in these directories: ['/tmp/auth0-fastapi-api-protection'] INFO: Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit) INFO: Started reloader process [46327] using WatchFiles INFO: Started server process [46329] INFO: Waiting for application startup. INFO: Application startup complete. Use the access token received to verify if we can access each of the above endpoints as intended $ curl -s http://localhost:8000/public | jq { \"status\": \"success\", \"data\": {}, \"message\": \"Successfully accessed public endpoint\" } $ curl -i http://localhost:8000/private \u0026\u0026 echo HTTP/1.1 403 Forbidden date: Fri, 18 Apr 2025 19:38:48 GMT server: uvicorn content-length: 54 content-type: application/json {\"error\":\"unknown_error\",\"detail\":\"Not authenticated\"} $ curl -s http://localhost:8000/private -H \"Authorization: Bearer $ACCESS_TOKEN\" | jq { \"status\": \"success\", \"data\": { \"user\": { \"iss\": \"https://dev-s6oegu3u80a0upg4.us.auth0.com/\", \"sub\": \"XStySocTNNAJkwa7kTNNGqrwYpHmueq7@clients\", \"aud\": \"https://api.example.com\", \"iat\": 1744937316, \"exp\": 1745023716, \"gty\": \"client-credentials\", \"azp\": \"XStySocTNNAJkwa7kTNNGqrwYpHmueq7\", \"permissions\": [] } }, \"message\": \"Successfully accessed private endpoint\" } $ curl -i http://localhost:8000/private/scoped \u0026\u0026 echo HTTP/1.1 403 Forbidden date: Fri, 18 Apr 2025 19:39:56 GMT server: uvicorn content-length: 54 content-type: application/json {\"error\":\"unknown_error\",\"detail\":\"Not authenticated\"} $ curl -s http://localhost:8000/private/scoped -H \"Authorization: Bearer $ACCESS_TOKEN\" | jq { \"status\": \"success\", \"data\": { \"user\": { \"iss\": \"https://dev-s6oegu3u80a0upg4.us.auth0.com/\", \"sub\": \"XStySocTNNAJkwa7kTNNGqrwYpHmueq7@clients\", \"aud\": \"https://api.example.com\", \"iat\": 1745005284, \"exp\": 1745091684, \"scope\": \"read:messages\", \"gty\": \"client-credentials\", \"azp\": \"XStySocTNNAJkwa7kTNNGqrwYpHmueq7\", \"permissions\": [ \"read:messages\" ] } }, \"message\": \"Successfully accessed scoped private endpoint\" } Navigate to “Applications -\u003e Application -\u003e Default App -\u003e API -\u003e sample-api \" drop down and uncheck “read:messages” permission Generate a new access token without required scopes using the Default App client credentials curl --request POST \\ --url \"https://$DOMAIN/oauth/token\" \\ --header 'content-type: application/json' \\ --data @- \u003c\u003c EOF | jq '.access_token' { \"client_id\":\"$CLIENT_ID\", \"client_secret\":\"$CLIENT_SECRET\", \"audience\":\"https://api.example.com\", \"grant_type\":\"client_credentials\" } EOF Export the token to an environment variable export ACCESS_TOKEN=eyJhbGciOiJSUzI1NiIsI... Attempt all the endpoints again to see the response $ curl -i http://localhost:8000/public \u0026\u0026 echo HTTP/1.1 200 OK date: Fri, 18 Apr 2025 00:50:22 GMT server: uvicorn content-length: 60 content-type: application/json {\"status\":\"success\",\"data\":{},\"message\":\"Successfully accessed public endpoint\"} $ curl -i http://localhost:8000/private -H \"Authorization: Bearer $ACCESS_TOKEN\" \u0026\u0026 echo HTTP/1.1 200 OK date: Fri, 18 Apr 2025 00:50:42 GMT server: uvicorn content-length: 394 content-type: application/json {\"status\":\"success\",\"data\":{\"user\":{\"iss\":\"https://dev-s6oegu3u80i0upf0.us.auth0.com/\",\"sub\":\"XStySocTNNAJkwa7kTNNGqrwYpHmueq7@clients\",\"aud\":\"https://api.example.com\",\"iat\":1745005284,\"exp\":1745091684,\"scope\":\"read:messages\",\"gty\":\"client-credentials\",\"azp\":\"XStySocTNNAJkwa7kTNNGqrwYpHmueq7\",\"permissions\":[\"read:messages\"]}},\"message\":\"Successfully accessed private endpoint\"} # Token fails to validate due to missing scope $ curl -i http://localhost:8000/private/scoped -H \"Authorization: Bearer $ACCESS_TOKEN\" \u0026\u0026 echo HTTP/1.1 403 Forbidden date: Fri, 18 Apr 2025 19:45:40 GMT server: uvicorn content-length: 81 content-type: application/json {\"error\":\"insufficient_scopes\",\"detail\":\"Missing required scopes: read:messages\"} References class fastapi.security.HTTPBearer SecurityScopes fastAPI.Security FasptAPI dependency injection Add Authorization to Your Flask API Application Auth0 API protection service settings ","wordCount":"1880","inLanguage":"en","image":"https://partbypart.github.io/posts/deep-dive-setup-auth0-authentication-authorization/images/oauth-auth0-api.png","datePublished":"2025-04-02T00:00:00Z","dateModified":"2025-04-02T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://partbypart.github.io/posts/deep-dive-setup-auth0-authentication-authorization/"},"publisher":{"@type":"Organization","name":"Learn part by part","logo":{"@type":"ImageObject","url":"https://partbypart.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://partbypart.github.io/ accesskey=h title="PartByPart (Alt + H)"><img src=https://partbypart.github.io/apple-touch-icon.png alt aria-label=logo height=35>PartByPart</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://partbypart.github.io/categories/ title=CATEGORIES><span>CATEGORIES</span></a></li><li><a href=https://partbypart.github.io/tags/ title=TAGS><span>TAGS</span></a></li><li><a href=https://partbypart.github.io/archives/ title=ARCHIVES><span>ARCHIVES</span></a></li><li><a href=https://partbypart.github.io/search/ title="SEARCH (Alt + /)" accesskey=/><span>SEARCH</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://partbypart.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://partbypart.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Protect FastAPI API endpoints with Auth0</h1><div class=post-description>Learn how to protect your FastAPI API endpoints using Auth0</div><div class=post-meta><span title='2025-04-02 00:00:00 +0000 UTC'>April 2, 2025</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;1880 words</div></header><figure class=entry-cover><img loading=eager src=https://partbypart.github.io/images/oauth-auth0-api.png alt="OAuth logo"><figcaption>Attribution: Chris Messina (<a href=https://upload.wikimedia.org/wikipedia/commons/d/d2/Oauth_logo.svg)>https://upload.wikimedia.org/wikipedia/commons/d/d2/Oauth_logo.svg)</a>, Api icons created by Freepik - Flaticon (<a href=https://www.flaticon.com/free-icons/api>https://www.flaticon.com/free-icons/api</a>)</figcaption></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#verify-access-to-api-using-audience>Verify access to API using audience</a></li><li><a href=#protect-your-webapp-backend-api-endpoints>Protect your webapp backend API endpoints</a></li><li><a href=#references>References</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h3 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h3><ul><li><p>Create an account on <a href=https://auth0.com/signup>https://auth0.com/signup</a> with a free plan</p></li><li><p>Navigate to &ldquo;Applications -> Applications&rdquo; to see your &ldquo;Default App&rdquo;. Grab the &ldquo;Client ID&rdquo;, &ldquo;Client Secret&rdquo; and &ldquo;Domain&rdquo; from &ldquo;Settings&rdquo; page of Default App</p></li><li><p>Navigate to &ldquo;Applications -> Applications -> Default App -> API&rdquo;</p><ul><li>Check Auth0 Management API checkbox to access management API using this app credentials</li><li>Click on the drop down to select the scopes/permissions for this app and select <code>read:users</code>, <code>update:users</code>, <code>read:roles</code> scopes. These will be required later to assign roles users after they complete a sign up</li></ul></li><li><p>Create a new API application on Auth0 : &ldquo;Applications -> API -> Create API&rdquo;</p><ul><li>Name: &lt;Provide a friendly name for the API> (Example: &ldquo;sample-api&rdquo;)</li><li>Identifier: &lt;A unique identifer name for your API endpoints> (This will be the <code>audience</code> in the issued token) (Example: &ldquo;<code>https://api.example.com</code>&rdquo;)</li><li>JWT Signing algorithm: RS256</li></ul></li><li><p>Create permissions for your API: Applications -> API -> &lt;your_API_app> -> Permissions</p><ul><li>Use &ldquo;Add a permission&rdquo; to add any number of permissions that you wish to use for all your endpoints. For this example:<ul><li>Permission: &ldquo;read:messages&rdquo;</li><li>Description: &ldquo;Read messages from a private endpoint with scope&rdquo;</li></ul></li><li>These permissions can either be granted to the web app (Tokens created using client credentials) OR to web app users using &ldquo;Roles&rdquo; and RBAC controls in Auth0</li></ul></li><li><p>Go to settings of the API created and check &ldquo;Enable RBAC&rdquo; box and &ldquo;Add permissions in the access token&rdquo; box. This allows access token to apply RBAC rules and inject required scopes into the token</p></li><li><p>Navigate to &ldquo;Applications -> Applications -> Default App -> APIs&rdquo; and perform the following actions:</p><ul><li>Turn on authorization for &ldquo;sample-api&rdquo;</li><li>Expand the dropdown to select granular permissions<ul><li><code>read:messages</code></li></ul></li><li>These are general set of scopes to be used by the entire webapp (Default app).</li><li>An access token created using the webapp&rsquo;s client credentials will receive an access token with <code>read:messages</code></li><li>NOTE: A user using this webapp that has authorization for this API will not receive this permission by default. If a user logs in to the webapp using consent screen, their access token will not have this permission by default. You have to create &ldquo;Role&rdquo; and enable RBAC controls to generate user access tokens with these permissions</li></ul></li><li><details><summary>Optional user scope management</summary><ul><li>For a production webapp, you would ideally:</li><li>Create a Role (User management -> Roles)</li><li>Make a note of the &ldquo;Role ID&rdquo; displayed below the name of the Role</li><li>Click &ldquo;Permissions -> Add permissions " for the created role</li><li>Select permissions from existing APIs (For example: Selecting &ldquo;sample-api&rdquo; will show you &ldquo;read:messages&rdquo; as an available permission) and click &ldquo;Add permissions&rdquo;</li><li>Click &ldquo;Actions -> Triggers -> post-user-registration&rdquo; (triggers after a new user has been created in the database.)<ul><li>&ldquo;Add action -> + -> Build from scratch&rdquo;</li><li>Name: &ldquo;Assign roles to users after signup&rdquo;</li><li>Trigger: &ldquo;Post User Registration&rdquo;</li><li>Create</li><li>Add the following secrets on the left side panel for the script to use<ul><li><code>clientId</code> (Client ID of your Default App)</li><li><code>clientSecret</code> (Client secret of your Default App)</li><li><code>domain</code> (Domain name of your Auth0 tenant account)</li><li><code>user_role_id</code> (The role id you want to assign all signed up users)</li></ul></li><li>Add the following script that creates a management client instance and updates the roles of a user<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl>  <span class=nx>exports</span><span class=p>.</span><span class=nx>onExecutePostUserRegistration</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>event</span><span class=p>,</span> <span class=nx>api</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>ManagementClient</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;auth0&#39;</span><span class=p>).</span><span class=nx>ManagementClient</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Initialize the Management Client
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>management</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ManagementClient</span><span class=p>({</span>
</span></span><span class=line><span class=cl>	<span class=nx>domain</span><span class=o>:</span> <span class=nx>event</span><span class=p>.</span><span class=nx>secrets</span><span class=p>.</span><span class=nx>domain</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>clientId</span><span class=o>:</span> <span class=nx>event</span><span class=p>.</span><span class=nx>secrets</span><span class=p>.</span><span class=nx>clientId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>clientSecret</span><span class=o>:</span> <span class=nx>event</span><span class=p>.</span><span class=nx>secrets</span><span class=p>.</span><span class=nx>clientSecret</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>scope</span><span class=o>:</span> <span class=s1>&#39;read:users update:users read:roles&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>userId</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>user_id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>roleId</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>secrets</span><span class=p>.</span><span class=nx>user_role_id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Get the user&#39;s current roles
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kr>const</span> <span class=nx>userRoles</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>management</span><span class=p>.</span><span class=nx>getUserRoles</span><span class=p>({</span> <span class=nx>id</span><span class=o>:</span> <span class=nx>userId</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Check if the user already has the &#34;User&#34; role
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kr>const</span> <span class=nx>hasUserRole</span> <span class=o>=</span> <span class=nx>userRoles</span><span class=p>.</span><span class=nx>some</span><span class=p>(</span><span class=nx>role</span> <span class=p>=&gt;</span> <span class=nx>role</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>roleId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>hasUserRole</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	  <span class=c1>// Assign the &#34;User&#34; role to the user
</span></span></span><span class=line><span class=cl><span class=c1></span>	  <span class=kr>await</span> <span class=nx>management</span><span class=p>.</span><span class=nx>assignRolestoUser</span><span class=p>({</span> <span class=nx>id</span><span class=o>:</span> <span class=nx>userId</span> <span class=p>},</span> <span class=p>{</span> <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span><span class=nx>roleId</span><span class=p>]</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>	  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Assigned &#34;User&#34; role to user </span><span class=si>${</span><span class=nx>userId</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;Error assigning role:&#39;</span><span class=p>,</span> <span class=nx>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div></li></ul></li><li>This will ensure that every user that signs up will have the Role attached to them and hence the permissions that come with the role.</li><li>This will add the role&rsquo;s permissions/scopes to the access tokens issued to the user after they login.</li></ul></details></li></ul><h3 id=verify-access-to-api-using-audience>Verify access to API using audience<a hidden class=anchor aria-hidden=true href=#verify-access-to-api-using-audience>#</a></h3><ul><li>Now that your Default App has authorization to use your newly created API, lets test it out. Get your Client ID, client secret and domain from the Settings page of your &ldquo;Default App&rdquo;</li><li>Send a curl request to verify if we get back an access token with &ldquo;sample-api&rdquo; identifier as audience<ul><li>Export webapp details as environment variables<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CLIENT_ID</span><span class=o>=</span> &lt;DEFAULT_APP_CLIENT_ID&gt;
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CLIENT_SECRET</span><span class=o>=</span> &lt;DEFAULT_APP_CLIENT_SECRET&gt;
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>DOMAIN</span><span class=o>=</span> &lt;DEFAULT_APP_DOMAIN&gt;
</span></span></code></pre></div></li><li>Curl request<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=err>curl</span> <span class=err>--request</span> <span class=err>POST</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>  <span class=err>--url</span> <span class=s2>&#34;https://$DOMAIN/oauth/token&#34;</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>  <span class=err>--header</span> <span class=err>&#39;content-type:</span> <span class=err>application/json&#39;</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>  <span class=err>--data</span> <span class=err>@-</span> <span class=err>&lt;&lt;</span> <span class=err>EOF</span> <span class=err>|</span> <span class=err>jq</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;client_id&#34;</span><span class=p>:</span><span class=s2>&#34;$CLIENT_ID&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;client_secret&#34;</span><span class=p>:</span><span class=s2>&#34;$CLIENT_SECRET&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;audience&#34;</span><span class=p>:</span><span class=s2>&#34;https://api.example.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;grant_type&#34;</span><span class=p>:</span><span class=s2>&#34;client_credentials&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=err>EOF</span>
</span></span></code></pre></div></li><li>Response<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;access_token&#34;</span><span class=p>:</span> <span class=s2>&#34;eyJhbGciOiJSUzI1NiIsInR5cCI...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scope&#34;</span><span class=p>:</span> <span class=s2>&#34;read:messages&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;expires_in&#34;</span><span class=p>:</span> <span class=mi>86400</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;token_type&#34;</span><span class=p>:</span> <span class=s2>&#34;Bearer&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>export</span> <span class=err>ACCESS_TOKEN=</span><span class=s2>&#34;eyJhbGciOiJSUzI1NiIsInR5cCI...&#34;</span>
</span></span></code></pre></div></li><li>Display the contents of access token payload to check if the right audience and scopes are injected<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=nv>$ACCESS_TOKEN</span> <span class=p>|</span> cut -d <span class=s1>&#39;.&#39;</span> -f2 <span class=p>|</span> base64 -d <span class=p>|</span>jq
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;iss&#34;</span>: <span class=s2>&#34;&lt;YOUR_DOMAIN_NAME&gt;&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;sub&#34;</span>: <span class=s2>&#34;XStySocTNNAJkwa7kTNNGqrwYpHmueq7@clients&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aud&#34;</span>: <span class=s2>&#34;https://api.example.com&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;iat&#34;</span>: 1744935715,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;exp&#34;</span>: 1745022115,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;scope&#34;</span>: <span class=s2>&#34;read:messages&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;gty&#34;</span>: <span class=s2>&#34;client-credentials&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;azp&#34;</span>: <span class=s2>&#34;XStySocTNNAJkwa7kTNNGqrwYpHmueq7&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;permissions&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;read:messages&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div></li></ul></li></ul><h3 id=protect-your-webapp-backend-api-endpoints>Protect your webapp backend API endpoints<a hidden class=anchor aria-hidden=true href=#protect-your-webapp-backend-api-endpoints>#</a></h3><ul><li>Create a simple FastAPI backend server</li><li>Create a <code>.env</code> file and store Auth0 domain and Auth0 API audience value for the backend server to validate incoming bearer tokens<ul><li>Example:<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat .env
</span></span><span class=line><span class=cl><span class=nv>AUTH0_DOMAIN</span><span class=o>=</span>dev-s6oegu3u80a0upg4.us.auth0.com
</span></span><span class=line><span class=cl><span class=nv>API_AUDIENCE</span><span class=o>=</span>https://api.example.com
</span></span></code></pre></div></li></ul></li><li>Create 3 API endpoints<ul><li><code>/public</code> - Returns a 200 OK success response without any authentication</li><li><code>/private</code> - Returns a 200 OK success response with a valid bearer token (no scope requiredment). Error otherwise</li><li><code>/private/scoped</code> - Returns a 200 OK success response with a valid bearer token and a valid scope. Error otherwise</li></ul></li></ul><ul><li>Sample server<ul><li><p>Create a new directory for sample server backend</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir auth0-fastapi-api-protection<span class=p>;</span> <span class=nb>cd</span> auth0-fastapi-api-protection
</span></span></code></pre></div></li><li><p>Create a virtual environment to install dependencies using <code>uv</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install uv uvicorn<span class=p>;</span> uv venv .venv
</span></span></code></pre></div></li><li><p>Create a <code>requirements.txt</code> to list the dependencies to install</p><figure><figcaption>requirements.txt</figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fastapi
</span></span><span class=line><span class=cl>uvicorn<span class=o>[</span>standard<span class=o>]</span>
</span></span><span class=line><span class=cl>python-jose<span class=o>[</span>cryptography<span class=o>]</span>
</span></span><span class=line><span class=cl>requests
</span></span><span class=line><span class=cl>jwt
</span></span></code></pre></div></figure></li><li><p>Install dependencies using <code>uv</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>source</span> .venv/bin/activate<span class=p>;</span> uv pip install -r requirements.txt
</span></span></code></pre></div></li><li><p>Create a <code>server.py</code> file with the following contents</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>Depends</span><span class=p>,</span> <span class=n>HTTPException</span><span class=p>,</span> <span class=n>status</span><span class=p>,</span> <span class=n>Security</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi.security</span> <span class=kn>import</span> <span class=n>HTTPBearer</span><span class=p>,</span> <span class=n>HTTPAuthorizationCredentials</span><span class=p>,</span> <span class=n>SecurityScopes</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi.responses</span> <span class=kn>import</span> <span class=n>JSONResponse</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>jose</span> <span class=kn>import</span> <span class=n>jwt</span><span class=p>,</span> <span class=n>JWTError</span><span class=p>,</span> <span class=n>ExpiredSignatureError</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dotenv</span> <span class=kn>import</span> <span class=n>load_dotenv</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>lru_cache</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timezone</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Configure logging</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Load environment variables</span>
</span></span><span class=line><span class=cl><span class=n>load_dotenv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Environment variables</span>
</span></span><span class=line><span class=cl><span class=n>AUTH0_DOMAIN</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;AUTH0_DOMAIN&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>API_AUDIENCE</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;API_AUDIENCE&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ALGORITHMS</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;RS256&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ensure required environment variables are set</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=ow>not</span> <span class=nb>all</span><span class=p>([</span><span class=n>AUTH0_DOMAIN</span><span class=p>,</span> <span class=n>API_AUDIENCE</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&#34;Missing required environment variables&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Initialize FastAPI app</span>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>title</span><span class=o>=</span><span class=s2>&#34;Secure API&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;API with JWT-based authentication and authorization&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>version</span><span class=o>=</span><span class=s2>&#34;1.0.0&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Security scheme</span>
</span></span><span class=line><span class=cl><span class=n>bearer_scheme</span> <span class=o>=</span> <span class=n>HTTPBearer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Pydantic models for response standardization</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ErrorResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>error</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>detail</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SuccessResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Cache JWKS with LRU cache</span>
</span></span><span class=line><span class=cl><span class=nd>@lru_cache</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fetch_jwks</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>jwks_url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;https://</span><span class=si>{</span><span class=n>AUTH0_DOMAIN</span><span class=si>}</span><span class=s2>/.well-known/jwks.json&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>jwks_url</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>RequestException</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Failed to fetch JWKS: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_503_SERVICE_UNAVAILABLE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;Unable to fetch authentication keys&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_signing_key</span><span class=p>(</span><span class=n>token</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>unverified_header</span> <span class=o>=</span> <span class=n>jwt</span><span class=o>.</span><span class=n>get_unverified_header</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>kid</span> <span class=o>=</span> <span class=n>unverified_header</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;kid&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>jwks</span> <span class=o>=</span> <span class=n>fetch_jwks</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=nb>next</span><span class=p>((</span><span class=n>k</span> <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>jwks</span><span class=p>[</span><span class=s2>&#34;keys&#34;</span><span class=p>]</span> <span class=k>if</span> <span class=n>k</span><span class=p>[</span><span class=s2>&#34;kid&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=n>kid</span><span class=p>),</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>key</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_401_UNAUTHORIZED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;Invalid signing key&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>key</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>JWTError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error processing token header: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_401_UNAUTHORIZED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;Invalid token header&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>verify_token</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>credentials</span><span class=p>:</span> <span class=n>HTTPAuthorizationCredentials</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>bearer_scheme</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=n>token</span> <span class=o>=</span> <span class=n>credentials</span><span class=o>.</span><span class=n>credentials</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>rsa_key</span> <span class=o>=</span> <span class=n>get_signing_key</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span> <span class=o>=</span> <span class=n>jwt</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>token</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>rsa_key</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>algorithms</span><span class=o>=</span><span class=n>ALGORITHMS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>audience</span><span class=o>=</span><span class=n>API_AUDIENCE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>issuer</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;https://</span><span class=si>{</span><span class=n>AUTH0_DOMAIN</span><span class=si>}</span><span class=s2>/&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Token verified for user: </span><span class=si>{</span><span class=n>payload</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;sub&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>payload</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>ExpiredSignatureError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&#34;Token expired&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_401_UNAUTHORIZED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>detail</span><span class=o>=</span><span class=n>ErrorResponse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>error</span><span class=o>=</span><span class=s2>&#34;token_expired&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;The provided token has expired&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span><span class=o>.</span><span class=n>model_dump</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>JWTError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Token validation failed: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_401_UNAUTHORIZED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>detail</span><span class=o>=</span><span class=n>ErrorResponse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>error</span><span class=o>=</span><span class=s2>&#34;invalid_token&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>detail</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;Token validation failed: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span><span class=o>.</span><span class=n>model_dump</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>verify_token_with_scopes</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>security_scopes</span><span class=p>:</span> <span class=n>SecurityScopes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>verify_token</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=n>token_scopes</span> <span class=o>=</span> <span class=n>payload</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;scope&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>missing_scopes</span> <span class=o>=</span> <span class=p>[</span><span class=n>scope</span> <span class=k>for</span> <span class=n>scope</span> <span class=ow>in</span> <span class=n>security_scopes</span><span class=o>.</span><span class=n>scopes</span> <span class=k>if</span> <span class=n>scope</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>token_scopes</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>missing_scopes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(</span><span class=n>timezone</span><span class=o>.</span><span class=n>utc</span><span class=p>)</span><span class=o>.</span><span class=n>isoformat</span><span class=p>()</span><span class=si>}</span><span class=s2>: Missing required scopes: </span><span class=si>{</span><span class=n>missing_scopes</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_403_FORBIDDEN</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>detail</span><span class=o>=</span><span class=n>ErrorResponse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>error</span><span class=o>=</span><span class=s2>&#34;insufficient_scopes&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>detail</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;Missing required scopes: </span><span class=si>{</span><span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>missing_scopes</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span><span class=o>.</span><span class=n>model_dump</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>payload</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.exception_handler</span><span class=p>(</span><span class=n>HTTPException</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>http_exception_handler</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>exc</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Handle both dictionary and string detail formats</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>exc</span><span class=o>.</span><span class=n>detail</span><span class=p>,</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>error</span> <span class=o>=</span> <span class=n>exc</span><span class=o>.</span><span class=n>detail</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;error&#34;</span><span class=p>,</span> <span class=s2>&#34;unknown_error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>detail</span> <span class=o>=</span> <span class=n>exc</span><span class=o>.</span><span class=n>detail</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;detail&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>exc</span><span class=o>.</span><span class=n>detail</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>error</span> <span class=o>=</span> <span class=s2>&#34;unknown_error&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>detail</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>exc</span><span class=o>.</span><span class=n>detail</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>JSONResponse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>status_code</span><span class=o>=</span><span class=n>exc</span><span class=o>.</span><span class=n>status_code</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=n>error</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;detail&#34;</span><span class=p>:</span> <span class=n>detail</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;/public&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>response_model</span><span class=o>=</span><span class=n>SuccessResponse</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>summary</span><span class=o>=</span><span class=s2>&#34;Public endpoint&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;Accessible without authentication&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>public_endpoint</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>SuccessResponse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>status</span><span class=o>=</span><span class=s2>&#34;success&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>=</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>        <span class=n>message</span><span class=o>=</span><span class=s2>&#34;Successfully accessed public endpoint&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;/private&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>response_model</span><span class=o>=</span><span class=n>SuccessResponse</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>summary</span><span class=o>=</span><span class=s2>&#34;Private endpoint&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;Requires valid JWT authentication&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>private_endpoint</span><span class=p>(</span><span class=n>payload</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>verify_token</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>SuccessResponse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>status</span><span class=o>=</span><span class=s2>&#34;success&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;user&#34;</span><span class=p>:</span> <span class=n>payload</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>message</span><span class=o>=</span><span class=s2>&#34;Successfully accessed private endpoint&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;/private/scoped&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>response_model</span><span class=o>=</span><span class=n>SuccessResponse</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>summary</span><span class=o>=</span><span class=s2>&#34;Scoped private endpoint&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;Requires valid JWT with &#39;read:messages&#39; scope&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>private_scoped_endpoint</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=n>Security</span><span class=p>(</span><span class=n>verify_token_with_scopes</span><span class=p>,</span> <span class=n>scopes</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;read:messages&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>SuccessResponse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>status</span><span class=o>=</span><span class=s2>&#34;success&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;user&#34;</span><span class=p>:</span> <span class=n>payload</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>message</span><span class=o>=</span><span class=s2>&#34;Successfully accessed scoped private endpoint&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span></code></pre></div></li></ul></li><li>Start the server<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ uvicorn server:app --reload --port <span class=m>8000</span>
</span></span><span class=line><span class=cl>INFO:     Will watch <span class=k>for</span> changes in these directories: <span class=o>[</span><span class=s1>&#39;/tmp/auth0-fastapi-api-protection&#39;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>INFO:     Uvicorn running on http://127.0.0.1:8000 <span class=o>(</span>Press CTRL+C to quit<span class=o>)</span>
</span></span><span class=line><span class=cl>INFO:     Started reloader process <span class=o>[</span>46327<span class=o>]</span> using WatchFiles
</span></span><span class=line><span class=cl>INFO:     Started server process <span class=o>[</span>46329<span class=o>]</span>
</span></span><span class=line><span class=cl>INFO:     Waiting <span class=k>for</span> application startup.
</span></span><span class=line><span class=cl>INFO:     Application startup complete.
</span></span></code></pre></div></li><li>Use the access token received to verify if we can access each of the above endpoints as intended<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl -s http://localhost:8000/public <span class=p>|</span> jq
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;success&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;data&#34;</span>: <span class=o>{}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Successfully accessed public endpoint&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ curl -i http://localhost:8000/private <span class=o>&amp;&amp;</span> <span class=nb>echo</span>
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>403</span> Forbidden
</span></span><span class=line><span class=cl>date: Fri, <span class=m>18</span> Apr <span class=m>2025</span> 19:38:48 GMT
</span></span><span class=line><span class=cl>server: uvicorn
</span></span><span class=line><span class=cl>content-length: <span class=m>54</span>
</span></span><span class=line><span class=cl>content-type: application/json
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;error&#34;</span>:<span class=s2>&#34;unknown_error&#34;</span>,<span class=s2>&#34;detail&#34;</span>:<span class=s2>&#34;Not authenticated&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ curl -s http://localhost:8000/private -H <span class=s2>&#34;Authorization: Bearer </span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=p>|</span> jq
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;success&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;data&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;user&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;iss&#34;</span>: <span class=s2>&#34;https://dev-s6oegu3u80a0upg4.us.auth0.com/&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;sub&#34;</span>: <span class=s2>&#34;XStySocTNNAJkwa7kTNNGqrwYpHmueq7@clients&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;aud&#34;</span>: <span class=s2>&#34;https://api.example.com&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;iat&#34;</span>: 1744937316,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;exp&#34;</span>: 1745023716,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;gty&#34;</span>: <span class=s2>&#34;client-credentials&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;azp&#34;</span>: <span class=s2>&#34;XStySocTNNAJkwa7kTNNGqrwYpHmueq7&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;permissions&#34;</span>: <span class=o>[]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Successfully accessed private endpoint&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ curl -i http://localhost:8000/private/scoped <span class=o>&amp;&amp;</span> <span class=nb>echo</span>
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>403</span> Forbidden
</span></span><span class=line><span class=cl>date: Fri, <span class=m>18</span> Apr <span class=m>2025</span> 19:39:56 GMT
</span></span><span class=line><span class=cl>server: uvicorn
</span></span><span class=line><span class=cl>content-length: <span class=m>54</span>
</span></span><span class=line><span class=cl>content-type: application/json
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;error&#34;</span>:<span class=s2>&#34;unknown_error&#34;</span>,<span class=s2>&#34;detail&#34;</span>:<span class=s2>&#34;Not authenticated&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ curl -s http://localhost:8000/private/scoped -H <span class=s2>&#34;Authorization: Bearer </span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=p>|</span> jq
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;success&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;data&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;user&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;iss&#34;</span>: <span class=s2>&#34;https://dev-s6oegu3u80a0upg4.us.auth0.com/&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;sub&#34;</span>: <span class=s2>&#34;XStySocTNNAJkwa7kTNNGqrwYpHmueq7@clients&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;aud&#34;</span>: <span class=s2>&#34;https://api.example.com&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;iat&#34;</span>: 1745005284,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;exp&#34;</span>: 1745091684,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;scope&#34;</span>: <span class=s2>&#34;read:messages&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;gty&#34;</span>: <span class=s2>&#34;client-credentials&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;azp&#34;</span>: <span class=s2>&#34;XStySocTNNAJkwa7kTNNGqrwYpHmueq7&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;permissions&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;read:messages&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Successfully accessed scoped private endpoint&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div></li><li>Navigate to &ldquo;Applications -> Application -> Default App -> API -> sample-api " drop down and uncheck &ldquo;read:messages&rdquo; permission</li><li>Generate a new access token <strong>without required scopes</strong> using the Default App client credentials<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=err>curl</span> <span class=err>--request</span> <span class=err>POST</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>  <span class=err>--url</span> <span class=s2>&#34;https://$DOMAIN/oauth/token&#34;</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>  <span class=err>--header</span> <span class=err>&#39;content-type:</span> <span class=err>application/json&#39;</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>  <span class=err>--data</span> <span class=err>@-</span> <span class=err>&lt;&lt;</span> <span class=err>EOF</span> <span class=err>|</span> <span class=err>jq</span> <span class=err>&#39;.access_token&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;client_id&#34;</span><span class=p>:</span><span class=s2>&#34;$CLIENT_ID&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;client_secret&#34;</span><span class=p>:</span><span class=s2>&#34;$CLIENT_SECRET&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;audience&#34;</span><span class=p>:</span><span class=s2>&#34;https://api.example.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;grant_type&#34;</span><span class=p>:</span><span class=s2>&#34;client_credentials&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=err>EOF</span>
</span></span></code></pre></div></li><li>Export the token to an environment variable<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ACCESS_TOKEN</span><span class=o>=</span>eyJhbGciOiJSUzI1NiIsI...
</span></span></code></pre></div><ul><li>Attempt all the endpoints again to see the response<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl -i http://localhost:8000/public <span class=o>&amp;&amp;</span> <span class=nb>echo</span>
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>date: Fri, <span class=m>18</span> Apr <span class=m>2025</span> 00:50:22 GMT
</span></span><span class=line><span class=cl>server: uvicorn
</span></span><span class=line><span class=cl>content-length: <span class=m>60</span>
</span></span><span class=line><span class=cl>content-type: application/json
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;status&#34;</span>:<span class=s2>&#34;success&#34;</span>,<span class=s2>&#34;data&#34;</span>:<span class=o>{}</span>,<span class=s2>&#34;message&#34;</span>:<span class=s2>&#34;Successfully accessed public endpoint&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ curl -i http://localhost:8000/private -H <span class=s2>&#34;Authorization: Bearer </span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span>
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>date: Fri, <span class=m>18</span> Apr <span class=m>2025</span> 00:50:42 GMT
</span></span><span class=line><span class=cl>server: uvicorn
</span></span><span class=line><span class=cl>content-length: <span class=m>394</span>
</span></span><span class=line><span class=cl>content-type: application/json
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;status&#34;</span>:<span class=s2>&#34;success&#34;</span>,<span class=s2>&#34;data&#34;</span>:<span class=o>{</span><span class=s2>&#34;user&#34;</span>:<span class=o>{</span><span class=s2>&#34;iss&#34;</span>:<span class=s2>&#34;https://dev-s6oegu3u80i0upf0.us.auth0.com/&#34;</span>,<span class=s2>&#34;sub&#34;</span>:<span class=s2>&#34;XStySocTNNAJkwa7kTNNGqrwYpHmueq7@clients&#34;</span>,<span class=s2>&#34;aud&#34;</span>:<span class=s2>&#34;https://api.example.com&#34;</span>,<span class=s2>&#34;iat&#34;</span>:1745005284,<span class=s2>&#34;exp&#34;</span>:1745091684,<span class=s2>&#34;scope&#34;</span>:<span class=s2>&#34;read:messages&#34;</span>,<span class=s2>&#34;gty&#34;</span>:<span class=s2>&#34;client-credentials&#34;</span>,<span class=s2>&#34;azp&#34;</span>:<span class=s2>&#34;XStySocTNNAJkwa7kTNNGqrwYpHmueq7&#34;</span>,<span class=s2>&#34;permissions&#34;</span>:<span class=o>[</span><span class=s2>&#34;read:messages&#34;</span><span class=o>]}}</span>,<span class=s2>&#34;message&#34;</span>:<span class=s2>&#34;Successfully accessed private endpoint&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Token fails to validate due to missing scope</span>
</span></span><span class=line><span class=cl>$ curl -i http://localhost:8000/private/scoped -H <span class=s2>&#34;Authorization: Bearer </span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span>
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>403</span> Forbidden
</span></span><span class=line><span class=cl>date: Fri, <span class=m>18</span> Apr <span class=m>2025</span> 19:45:40 GMT
</span></span><span class=line><span class=cl>server: uvicorn
</span></span><span class=line><span class=cl>content-length: <span class=m>81</span>
</span></span><span class=line><span class=cl>content-type: application/json
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;error&#34;</span>:<span class=s2>&#34;insufficient_scopes&#34;</span>,<span class=s2>&#34;detail&#34;</span>:<span class=s2>&#34;Missing required scopes: read:messages&#34;</span><span class=o>}</span>
</span></span></code></pre></div></li></ul></li></ul><h3 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h3><ul><li><a href="https://fastapi.tiangolo.com/reference/security/?h=httpbearer#fastapi.security.HTTPBearer">class fastapi.security.HTTPBearer</a></li><li><a href="https://fastapi.tiangolo.com/advanced/security/oauth2-scopes/?h=securityscopes#use-securityscopes">SecurityScopes</a></li><li><a href="https://fastapi.tiangolo.com/reference/dependencies/?h=security#fastapi.Security">fastAPI.Security</a></li><li><a href=https://fastapi.tiangolo.com/tutorial/dependencies/#what-is-dependency-injection>FasptAPI dependency injection</a></li><li><a href=https://auth0.com/docs/quickstart/backend/python/interactive>Add Authorization to Your Flask API Application</a></li><li><a href=https://auth0.com/docs/get-started/apis/api-settings>Auth0 API protection service settings</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://partbypart.github.io/tags/howto/>Howto</a></li><li><a href=https://partbypart.github.io/tags/oauth/>Oauth</a></li><li><a href=https://partbypart.github.io/tags/auth0/>Auth0</a></li><li><a href=https://partbypart.github.io/tags/api/>Api</a></li></ul><nav class=paginav><a class=next href=https://partbypart.github.io/posts/quick-bytes-oauth-2.0/><span class=title>Next »</span><br><span>Quick bytes - Introduction to OAuth 2.0</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Protect FastAPI API endpoints with Auth0 on x" href="https://x.com/intent/tweet/?text=Protect%20FastAPI%20API%20endpoints%20with%20Auth0&amp;url=https%3a%2f%2fpartbypart.github.io%2fposts%2fdeep-dive-setup-auth0-authentication-authorization%2f&amp;hashtags=howto%2coauth%2cauth0%2capi"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Protect FastAPI API endpoints with Auth0 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fpartbypart.github.io%2fposts%2fdeep-dive-setup-auth0-authentication-authorization%2f&amp;title=Protect%20FastAPI%20API%20endpoints%20with%20Auth0&amp;summary=Protect%20FastAPI%20API%20endpoints%20with%20Auth0&amp;source=https%3a%2f%2fpartbypart.github.io%2fposts%2fdeep-dive-setup-auth0-authentication-authorization%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Protect FastAPI API endpoints with Auth0 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fpartbypart.github.io%2fposts%2fdeep-dive-setup-auth0-authentication-authorization%2f&title=Protect%20FastAPI%20API%20endpoints%20with%20Auth0"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Protect FastAPI API endpoints with Auth0 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fpartbypart.github.io%2fposts%2fdeep-dive-setup-auth0-authentication-authorization%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Protect FastAPI API endpoints with Auth0 on whatsapp" href="https://api.whatsapp.com/send?text=Protect%20FastAPI%20API%20endpoints%20with%20Auth0%20-%20https%3a%2f%2fpartbypart.github.io%2fposts%2fdeep-dive-setup-auth0-authentication-authorization%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Protect FastAPI API endpoints with Auth0 on telegram" href="https://telegram.me/share/url?text=Protect%20FastAPI%20API%20endpoints%20with%20Auth0&amp;url=https%3a%2f%2fpartbypart.github.io%2fposts%2fdeep-dive-setup-auth0-authentication-authorization%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Protect FastAPI API endpoints with Auth0 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Protect%20FastAPI%20API%20endpoints%20with%20Auth0&u=https%3a%2f%2fpartbypart.github.io%2fposts%2fdeep-dive-setup-auth0-authentication-authorization%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://partbypart.github.io/>Learn part by part</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a><br><a href=https://www.flaticon.com/free-icons/timber title="timber icons">Timber icons created by imaginationlol - Flaticon</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>